apiVersion: v1
kind: ConfigMap
metadata:
  name: sedekah-config
  namespace: sedekah
data:
  APP_NAME: "Sedekah.info"
  APP_ENV: "production"
  APP_DEBUG: "false"
  APP_URL: "https://sedekah.info"

  APP_LOCALE: "en"
  APP_FALLBACK_LOCALE: "en"

  LOG_CHANNEL: "stack"
  LOG_LEVEL: "error"

  DB_CONNECTION: "mysql"
  DB_HOST: "sedekah-db"
  DB_PORT: "3306"
  DB_DATABASE: "sedekah"

  SESSION_DRIVER: "database"
  SESSION_LIFETIME: "120"

  CACHE_STORE: "database"
  QUEUE_CONNECTION: "database"

  FILESYSTEM_DISK: "r2"

  MAIL_MAILER: "smtp"
  MAIL_PORT: "587"
  MAIL_ENCRYPTION: "tls"
  MAIL_FROM_ADDRESS: "noreply@sedekah.info"
  MAIL_FROM_NAME: "Sedekah.info"

---
# Nginx configuration as a ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: sedekah-nginx-config
  namespace: sedekah
data:
  default.conf: |
    server {
        listen 80;
        server_name _;
        root /var/www/public;
        index index.php;

        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        gzip on;
        gzip_types text/plain text/css application/json application/javascript image/svg+xml;
        gzip_min_length 256;

        location /build/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri =404;
        }

        location /storage/ {
            expires 7d;
            add_header Cache-Control "public";
            try_files $uri =404;
        }

        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        location ~ \.php$ {
            fastcgi_pass sedekah-app:9000;
            fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
            include fastcgi_params;
            fastcgi_hide_header X-Powered-By;
        }

        location ~ /\.(?!well-known).* {
            deny all;
        }
    }
